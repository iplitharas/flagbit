<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Flagship Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .flag-on { border-left: 5px solid #28a745; }
    .flag-off { border-left: 5px solid #dc3545; }
    .flag-card { transition: transform 0.2s, box-shadow 0.2s; }
    .flag-card:hover { transform: scale(1.02); box-shadow: 0px 8px 20px rgba(0,0,0,0.15); }
    .flag-header { display: flex; justify-content: space-between; align-items: center; }
    .flag-footer { display: flex; justify-content: flex-end; gap: 0.5rem; }
    .search-bar { max-width: 400px; }
  </style>
</head>
<body class="bg-light">

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#">ðŸš© Flagship</a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="https://github.com/your-org/flagship" target="_blank">GitHub</a></li>
        <li class="nav-item"><a class="nav-link" href="https://your-docs-url" target="_blank">Docs</a></li>
        <li class="nav-item"><a class="nav-link" href="#">About</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container my-4">

  <!-- Search and Filters -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <!-- Search -->
    <div class="input-group search-bar">
      <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
      <input type="text" id="filterName" class="form-control" placeholder="Search flags by name...">
    </div>

    <!-- Value filter -->
    <div>
      <select id="filterValue" class="form-select">
        <option value="all">All values</option>
        <option value="true">ON</option>
        <option value="false">OFF</option>
      </select>
    </div>
  </div>

  <!-- Create Flag Accordion -->
  <div class="accordion mb-4" id="createAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCreate">
          âž• Create New Flag
        </button>
      </h2>
      <div id="collapseCreate" class="accordion-collapse collapse" data-bs-parent="#createAccordion">
        <div class="accordion-body">
          <form id="createFlagForm" class="row g-3">
            <div class="col-md-3">
              <input type="text" id="flagName" class="form-control" placeholder="Flag name" required>
            </div>
            <div class="col-md-3">
              <input type="text" id="flagDesc" class="form-control" placeholder="Description">
            </div>
            <div class="col-md-2">
              <select id="flagValue" class="form-select">
                <option value="true">ON</option>
                <option value="false">OFF</option>
              </select>
            </div>
            <div class="col-md-2">
              <input type="date" id="flagExpiry" class="form-control">
              <small class="text-muted">Optional</small>
            </div>
            <div class="col-md-2">
              <button type="submit" class="btn btn-primary w-100">Create</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Flags List -->
  <div id="flagsContainer" class="row g-3"></div>
</div>

<!-- Toast Container -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
  <div id="toastContainer"></div>
</div>

<!-- Update Modal -->
<div class="modal fade" id="updateModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="updateFlagForm">
        <div class="modal-header">
          <h5 class="modal-title">Update Flag</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="updateIndex">
          <div class="mb-3">
            <label class="form-label">Description</label>
            <input type="text" id="updateDesc" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Value</label>
            <select id="updateValue" class="form-select">
              <option value="true">ON</option>
              <option value="false">OFF</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Expiry Date</label>
            <input type="date" id="updateExpiry" class="form-control">
            <small class="text-muted">Leave empty for no expiration</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">


<script>
  const flags = [];

  function showToast(message, type="success") {
    const toastId = `toast-${Date.now()}`;
    const toastHTML = `
      <div id="${toastId}" class="toast align-items-center text-bg-${type} border-0 mb-2" role="alert">
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>`;
    document.getElementById('toastContainer').insertAdjacentHTML('beforeend', toastHTML);
    new bootstrap.Toast(document.getElementById(toastId), { delay: 2000 }).show();
  }

  function renderFlags() {
    const container = document.getElementById('flagsContainer');
    container.innerHTML = '';
    const now = new Date();
    const filterName = document.getElementById('filterName').value.toLowerCase();
    const filterValue = document.getElementById('filterValue').value;

    flags
      .filter(flag =>
        flag.name.toLowerCase().includes(filterName) &&
        (filterValue === "all" || String(flag.value) === filterValue)
      )
      .forEach((flag, index) => {
        let expiryDisplay = "No expiration";
        let badge = "";
        if (flag.expired) {
          const expDate = new Date(flag.expired);
          if (expDate < now) {
            flag.value = false;
            expiryDisplay = `Expired on ${expDate.toLocaleDateString()}`;
            badge = `<span class="badge bg-danger ms-2">Expired</span>`;
          } else {
            const diffDays = Math.ceil((expDate - now) / (1000 * 60 * 60 * 24));
            expiryDisplay = `${expDate.toLocaleDateString()} (in ${diffDays} days)`;
            if (diffDays <= 7) {
              badge = `<span class="badge bg-warning text-dark ms-2">âš  Expires in ${diffDays} days</span>`;
            } else {
              badge = `<span class="badge bg-success ms-2">âœ… Expires in ${diffDays} days</span>`;
            }
          }
        }

        const card = document.createElement('div');
        card.className = `col-md-4`;
        card.innerHTML = `
          <div class="card flag-card ${flag.value ? 'flag-on' : 'flag-off'}">
            <div class="card-body">
              <div class="flag-header">
                <h5 class="card-title mb-0">${flag.name}</h5>
                <div class="form-check form-switch">
                  <input class="form-check-input toggle-switch" type="checkbox" ${flag.value ? 'checked' : ''} ${badge.includes("Expired") ? 'disabled' : ''}>
                </div>
              </div>
              <p class="card-text mt-2">${flag.desc || ''}</p>
              <p><strong>Status:</strong> ${flag.value ? 'ON' : 'OFF'}</p>
              <p class="text-muted mb-1">Created: ${flag.dateCreated}</p>
              <p class="text-muted mb-1">Updated: ${flag.dateUpdated}</p>
              <p class="mb-2">Expiry: ${expiryDisplay} ${badge}</p>
              <div class="flag-footer">
                <button class="btn btn-sm btn-warning update-btn">Update</button>
                <button class="btn btn-sm btn-outline-danger delete-btn">Delete</button>
              </div>
            </div>
          </div>`;

        container.appendChild(card);

        // Toggle
        card.querySelector('.toggle-switch').addEventListener('change', (e) => {
          if (flag.expired && new Date(flag.expired) < now) {
            e.target.checked = false;
            showToast(`Flag "${flag.name}" is expired and cannot be toggled.`, 'danger');
            return;
          }
          flag.value = e.target.checked;
          flag.dateUpdated = new Date().toLocaleString();
          showToast(`Flag "${flag.name}" set to ${flag.value ? 'ON' : 'OFF'}`, flag.value ? 'success' : 'danger');
          renderFlags();
        });

        // Delete
        card.querySelector('.delete-btn').addEventListener('click', () => {
          flags.splice(index, 1);
          showToast(`Flag "${flag.name}" deleted`, 'warning');
          renderFlags();
        });

        // Update
        card.querySelector('.update-btn').addEventListener('click', () => {
          document.getElementById('updateIndex').value = index;
          document.getElementById('updateDesc').value = flag.desc;
          document.getElementById('updateValue').value = flag.value ? 'true' : 'false';
          document.getElementById('updateExpiry').value = flag.expired || '';
          new bootstrap.Modal(document.getElementById('updateModal')).show();
        });
      });
  }

  // Create
  document.getElementById('createFlagForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const name = document.getElementById('flagName').value.trim();
    if (!name) { showToast("Flag name is required", "danger"); return; }
    const desc = document.getElementById('flagDesc').value.trim();
    const value = document.getElementById('flagValue').value === 'true';
    const expired = document.getElementById('flagExpiry').value || null;
    const now = new Date().toLocaleString();
    flags.push({ name, desc, value, expired, dateCreated: now, dateUpdated: now });
    showToast(`Flag "${name}" created`, 'primary');
    renderFlags();
    e.target.reset();
    document.getElementById('flagExpiry').value = "";
  });

  // Update
  document.getElementById('updateFlagForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const index = document.getElementById('updateIndex').value;
    flags[index].desc = document.getElementById('updateDesc').value;
    flags[index].value = document.getElementById('updateValue').value === 'true';
    flags[index].expired = document.getElementById('updateExpiry').value || null;
    flags[index].dateUpdated = new Date().toLocaleString();
    showToast(`Flag "${flags[index].name}" updated`, 'info');
    renderFlags();
    bootstrap.Modal.getInstance(document.getElementById('updateModal')).hide();
  });

  // Filters
  document.getElementById('filterName').addEventListener('input', renderFlags);
  document.getElementById('filterValue').addEventListener('change', renderFlags);



   async function fetchAndPopulateFlags(flagName = null) {
    try {
      const url = new URL('/flags', window.location.origin);
      if (flagName) {
        url.searchParams.set('flag_name', flagName);
      }

      const res = await fetch(url.toString(), {
        method: 'GET',
        headers: { 'Accept': 'application/json' },
        credentials: 'same-origin',
      });

      if (!res.ok) {
        const body = await res.text().catch(() => '');
        console.error(`Failed to fetch flags: ${res.status} ${res.statusText}`, body);
        return flags;
      }

      const data = await res.json();

      // Update the const array in place
      flags.length = 0;
      if (Array.isArray(data)) {
        flags.push(...data);
      } else if (data) {
        flags.push(data);
      }

      return flags;
    } catch (err) {
      console.error('Error fetching flags:', err);
      return flags;
    }
  }
  document.addEventListener('DOMContentLoaded', () => {
    fetchAndPopulateFlags().then(() => {
     renderFlags();
    });
  });


</script>
</body>
</html>
